<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nuevo Activo - Ruby QR Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            50: '#fff1f2', 100: '#ffe4e6', 200: '#fecdd3',
                            500: '#f43f5e', 600: '#e11d48', 700: '#be123c', 900: '#4c0519',
                        }
                    },
                    fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        body { 
            background: linear-gradient(to bottom, #f8fafc 0%, #f1f5f9 100%);
            min-height: 100vh;
        }
        .red-gradient { background: linear-gradient(135deg, #e11d48 0%, #9f1239 100%); }
        
        /* CONTENEDOR DE INPUT CON GRADIENTE SUTIL */
        .input-group-ruby {
            display: flex;
            align-items: stretch;
            border: 2px solid #cbd5e1;
            border-radius: 0.75rem;
            overflow: hidden;
            transition: all 0.3s;
            background: linear-gradient(to bottom, #ffffff 0%, #f8fafc 100%);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .input-group-ruby:focus-within {
            border-color: #e11d48;
            box-shadow: 0 0 0 4px rgba(255,241,242,1), 0 4px 12px rgba(225,29,72,0.1);
            background: linear-gradient(to bottom, #ffffff 0%, #fff1f2 100%);
        }
        
        /* ESPACIO PARA EL ICONO CON GRADIENTE */
        .input-icon-box {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 3rem;
            border-right: 2px solid #e2e8f0;
            color: #94a3b8;
            transition: all 0.3s;
            background: linear-gradient(to right, #f1f5f9, #f8fafc);
            cursor: pointer;
        }
        .input-group-ruby:focus-within .input-icon-box,
        .input-icon-box:hover {
            background: linear-gradient(to right, #ffe4e6, #fff1f2);
            color: #e11d48;
            border-right-color: #fecdd3;
        }
        
        /* ÁREA DE ESCRITURA */
        .input-ruby {
            flex: 1;
            padding: 0.625rem 1rem;
            font-size: 0.875rem;
            font-weight: 700;
            outline: none;
            background: transparent;
        }
        .input-ruby::placeholder {
            color: #cbd5e1;
        }
        
        .label-ruby {
            font-size: 0.6875rem;
            font-weight: 800;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 0.5rem;
            display: block;
        }
        
        .modal { background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(4px); }
        
        .bg-white { box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
    </style>
</head>
<body class="text-slate-800 antialiased font-sans pb-20">

    {% if msg %}
    <div class="toast-container position-fixed top-0 end-0 p-4" style="z-index: 1060;">
        <div id="liveToast" class="toast show border-0 rounded-2xl shadow-2xl overflow-hidden" role="alert">
            <div class="flex items-center p-4 bg-slate-900 text-white border-l-4 border-brand-600">
                <i class="fas fa-bell mr-3 text-brand-500"></i>
                <div class="toast-body font-bold text-sm">{{ msg }}</div>
                <button type="button" class="ml-auto text-white/50 hover:text-white" data-bs-dismiss="toast"><i class="fas fa-times"></i></button>
            </div>
        </div>
    </div>
    {% endif %}

    <nav class="sticky top-0 z-50 bg-white/90 backdrop-blur-md border-b-2 border-slate-200 px-4 py-3 md:px-8 shadow-sm">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <a href="/" class="flex items-center gap-2 group">
                <div class="p-1.5 bg-white border-2 border-brand-100 rounded-xl group-hover:rotate-2 transition-transform shadow-sm">
                    <img src="/static/logo.png" alt="Logo" class="h-6 w-auto">
                </div>
                <span class="font-black text-slate-900 tracking-tighter text-base uppercase">Nuevo<span class="text-brand-600">Activo</span></span>
            </a>
            <a href="/" class="text-xs font-bold text-slate-500 hover:text-brand-600 flex items-center gap-2 transition-all">
                <i class="fas fa-arrow-left text-[10px]"></i> Volver al Inicio
            </a>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto p-4 md:p-10">
        
        <form action="/crear" method="POST" id="formCrear" class="space-y-8">
            
            <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-4">
                <div class="flex items-center gap-4">
                    <div class="w-2 h-10 bg-brand-600 rounded-full shadow-[0_0_10px_#e11d48]"></div>
                    <h1 class="text-2xl font-black text-slate-900 tracking-tighter">Registrar <span class="text-brand-600">Nuevo Activo</span></h1>
                </div>
                <button type="button" class="px-5 py-2.5 bg-white border-2 border-slate-200 text-brand-600 rounded-xl font-black text-xs hover:border-brand-600 transition-all shadow-sm flex items-center gap-2" data-bs-toggle="modal" data-bs-target="#modalCargaExcel">
                    <i class="fas fa-file-excel"></i> IMPORTAR HOJA DE VIDA
                </button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                
                <div class="lg:col-span-8 space-y-6">
                    <div class="bg-white rounded-[2.5rem] border-2 border-slate-200 p-8 shadow-sm">
                        <h3 class="label-ruby !mb-8 pb-2 border-b-2 border-slate-50">Datos del Equipo</h3>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="label-ruby">Tipo de Equipo *</label>
                                <div class="input-group-ruby">
                                    <select class="input-ruby cursor-pointer" name="id_tipoequi" id="selectTipo" required onchange="toggleCampos()">
                                        <option value="">Seleccione...</option>
                                        {% for t in tipos %}
                                        <option value="{{ t.id_tipoequi }}" data-nombre="{{ t.nom_tipo }}"
                                            {% if pre_data and pre_data.tipo and pre_data.tipo in t.nom_tipo %}selected{% endif %}>
                                            {{ t.nom_tipo }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label class="label-ruby">Marca *</label>
                                <div class="input-group-ruby">
                                    <select class="input-ruby cursor-pointer" name="id_marca" id="selectMarca" required>
                                        <option value="">Seleccione...</option>
                                        {% for m in marcas %}
                                        <option value="{{ m.id_marca }}"
                                            {% if pre_data and pre_data.marca and pre_data.marca in m.nom_marca %}selected{% endif %}>
                                            {{ m.nom_marca }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>

                            <div id="col-modelo">
                                <label class="label-ruby">Modelo</label>
                                <div class="input-group-ruby">
                                    <select class="input-ruby cursor-pointer" name="id_modelo" id="selector-modelo">
                                        <option value="">(Genérico / Sin Modelo)</option>
                                        {% for mod in modelos %}
                                        <option value="{{ mod.id_modelo }}" data-tipo="{{ mod.id_tipoequi }}"
                                            {% if pre_data and pre_data.modelo and pre_data.modelo in mod.nom_modelo %}selected{% endif %}>
                                            {{ mod.nom_modelo }} ({{ mod.marca.nom_marca }})
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>

                            <div id="col-referencia">
                                <label class="label-ruby">Referencia</label>
                                <div class="input-group-ruby">
                                    <input type="text" name="referencia" class="input-ruby" placeholder="ESCRIBA AQUÍ" value="{{ pre_data.referencia if pre_data else '' }}">
                                </div>
                            </div>

                            <div class="md:col-span-2">
                                <label class="label-ruby text-brand-600">Serial del Fabricante (S/N) *</label>
                                <div class="input-group-ruby border-brand-100">
                                    <input type="text" name="serial" class="input-ruby font-mono uppercase text-base" placeholder="ESCRIBA AQUÍ" value="{{ pre_data.serial if pre_data else '' }}" required>
                                </div>
                            </div>

                            <div>
                                <label class="label-ruby">Estado</label>
                                <div class="input-group-ruby">
                                    <select name="estado" class="input-ruby">
                                        <option value="Bueno" selected>Bueno</option>
                                        <option value="Malo">Malo</option>
                                        <option value="En Reparación">En Reparación</option>
                                        <option value="Asignado">Asignado</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="grupo-redes" class="bg-white rounded-[2.5rem] border-2 border-slate-200 p-8 shadow-sm" style="display:none;">
                        <h3 class="label-ruby !text-brand-600 mb-6"><i class="fas fa-network-wired"></i> Red y Conectividad</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div id="grupo-hostname">
                                <label class="label-ruby">Hostname</label>
                                <input type="text" name="hostname" class="input-group-ruby px-4 py-2.5 text-xs font-bold font-mono outline-none" placeholder="ESCRIBA AQUÍ" value="{{ pre_data.hostname if pre_data else '' }}">
                            </div>
                            <div>
                                <label class="label-ruby">IP</label>
                                <input type="text" name="ip_equipo" class="input-group-ruby px-4 py-2.5 text-xs font-bold font-mono outline-none" placeholder="0.0.0.0" value="{{ pre_data.ip if pre_data else '' }}">
                            </div>
                            <div>
                                <label class="label-ruby">MAC</label>
                                <input type="text" name="mac_activo" class="input-group-ruby px-4 py-2.5 text-xs font-bold font-mono outline-none" placeholder="00:00:00..." value="{{ pre_data.mac if pre_data else '' }}">
                            </div>
                        </div>
                    </div>

                    {% if pre_data and pre_data.accesorios %}
                    <div class="bg-slate-900 rounded-[2.5rem] p-8 text-white shadow-xl border-2 border-slate-800">
                        <h3 class="text-sm font-black uppercase tracking-widest text-brand-500 mb-6 flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-brand-600 animate-pulse"></span> Accesorios Detectados
                        </h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left" id="tablaAccesorios">
                                <thead class="border-b border-white/10">
                                    <tr class="text-[9px] font-black text-slate-500 uppercase tracking-widest">
                                        <th class="pb-4 px-2">Tipo</th>
                                        <th class="pb-4 px-2">Detalles</th>
                                        <th class="pb-4 text-right">Acción</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-white/5">
                                    {% for acc in pre_data.accesorios %}
                                    <tr>
                                        <td class="py-4 px-2">
                                            <input type="text" class="bg-transparent border-0 text-xs font-bold text-white w-full outline-none acc-tipo" value="{{ acc.tipo }}" readonly>
                                        </td>
                                        <td class="py-4 px-2 space-y-2">
                                            <input type="text" class="block w-full bg-white/5 border border-white/10 rounded-lg px-3 py-1.5 text-[11px] text-white outline-none focus:border-brand-600 acc-marca" value="{{ acc.marca }}" placeholder="Marca">
                                            <input type="text" class="block w-full bg-white/5 border border-white/10 rounded-lg px-3 py-1.5 text-[11px] text-brand-400 font-bold outline-none focus:border-brand-600 acc-serial" value="{{ acc.serial }}" placeholder="Serial">
                                            <input type="text" class="block w-full bg-white/5 border border-white/10 rounded-lg px-3 py-1.5 text-[11px] text-white outline-none focus:border-brand-600 acc-ref" value="{{ acc.referencia or '' }}" placeholder="Ref">
                                        </td>
                                        <td class="py-4 text-right">
                                            <button type="button" class="text-slate-500 hover:text-brand-600 p-2" onclick="this.closest('tr').remove()"><i class="fas fa-trash-alt"></i></button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <div class="lg:col-span-4 space-y-6">
                    <div class="bg-white rounded-[2.5rem] border-2 border-slate-200 p-8 shadow-sm">
                        <h3 class="label-ruby !text-slate-400 mb-8 border-b border-slate-50 pb-2">Asignación</h3>
                        
                        <div class="space-y-6">
                            <div>
                                <label class="label-ruby">Cédula Responsable</label>
                                <div class="input-group-ruby">
                                    <button type="button" class="input-icon-box" onclick="buscarEmpleado()" title="Buscar Empleado">
                                        <i class="fas fa-search" id="icon-search"></i>
                                    </button>
                                    <input type="text" name="cod_responsable" id="input-responsable" 
                                           class="input-ruby" 
                                           placeholder="Ingrese y presione Enter" 
                                           value="{{ pre_data.responsable if pre_data else '' }}"
                                           onkeydown="if(event.key==='Enter'){event.preventDefault(); buscarEmpleado();}">
                                </div>
                                <div id="alerta-empleado" class="mt-3 p-3 bg-brand-50 rounded-xl border border-brand-100 text-[10px] font-bold text-brand-700">
                                    {% if pre_data and pre_data.responsable %} Sugerencia: <strong>{{ pre_data.responsable }}</strong>. {% endif %}
                                </div>
                            </div>

                            <div class="pt-6 border-t-2 border-slate-50 space-y-4">
                                <p class="text-[9px] font-black text-slate-300 uppercase">¿Nuevo Custodio?</p>
                                <div class="input-group-ruby">
                                    <div class="input-icon-box">
                                        <i class="fas fa-user-plus"></i>
                                    </div>
                                    <input type="text" name="nom_nuevo_empleado" id="nom_nuevo_empleado" class="input-ruby" placeholder="Nombre completo">
                                </div>
                                <div class="input-group-ruby">
                                    <div class="input-icon-box">
                                        <i class="fas fa-building"></i>
                                    </div>
                                    <select name="id_area_nuevo" id="id_area_nuevo" class="input-ruby cursor-pointer">
                                        <option value="">Seleccione Área...</option>
                                        {% for a in areas %}
                                        <option value="{{ a.id_area }}">{{ a.nom_area }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="grupo-padre" class="bg-slate-900 rounded-[2.5rem] p-8 text-white shadow-xl border-2 border-slate-800">
                        <label class="label-ruby !text-brand-500">Equipo Principal</label>
                        <select name="id_padre_activo" class="w-full bg-white/5 border-2 border-white/10 rounded-xl py-3 px-4 text-xs font-bold outline-none">
                            <option value="" class="text-slate-800">No, es un equipo principal</option>
                            {% for p in posibles_padres %}
                            <option value="{{ p.id_activo }}" class="text-slate-800">
                                {{ p.tipo.nom_tipo }} - {{ p.serial }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <input type="hidden" name="accesorios_json_final" id="accesoriosJson">
                    <button type="button" onclick="prepararYEnviar()" class="w-full py-5 red-gradient text-white rounded-[2rem] font-black uppercase shadow-xl shadow-brand-200 hover:scale-[1.02] transition-all flex items-center justify-center gap-3">
                        <i class="fas fa-save text-xl"></i> GUARDAR ACTIVO
                    </button>
                </div>
            </div>
        </form>
    </main>

    <div class="modal fade fixed inset-0 z-[1060] hidden overflow-y-auto" id="modalCargaExcel" tabindex="-1">
        <div class="modal-dialog relative w-auto pointer-events-none max-w-lg my-8 mx-auto px-4">
            <div class="modal-content border-2 border-brand-100 shadow-2xl relative flex flex-col w-full pointer-events-auto bg-white rounded-[2.5rem] overflow-hidden">
                <div class="p-6 bg-slate-900 text-white flex justify-between items-center">
                    <h5 class="text-xs font-black uppercase tracking-widest">Analizar Hoja de Vida</h5>
                    <button type="button" class="text-white/50 hover:text-white" data-bs-dismiss="modal"><i class="fas fa-times"></i></button>
                </div>
                <form action="/prellenar_desde_excel" method="POST" enctype="multipart/form-data">
                    <div class="p-10 text-center">
                        <div class="w-20 h-20 bg-brand-50 rounded-3xl flex items-center justify-center mx-auto mb-6 border-2 border-brand-100">
                            <i class="fas fa-file-upload text-3xl text-brand-600"></i>
                        </div>
                        <p class="text-xs text-slate-500 font-bold uppercase tracking-tighter mb-8 leading-relaxed">Suba el archivo Excel para detectar equipo y accesorios.</p>
                        <input type="file" name="file" accept=".xlsx" required class="w-full text-xs text-slate-500 file:mr-4 file:py-2.5 file:px-6 file:rounded-xl file:border-0 file:text-[10px] file:font-black file:bg-brand-600 file:text-white cursor-pointer shadow-lg">
                    </div>
                    <div class="p-6 bg-slate-50 flex gap-4">
                        <button type="button" class="flex-1 py-3 text-xs font-bold text-slate-400" data-bs-dismiss="modal">Cerrar</button>
                        <button type="submit" class="flex-1 py-3 red-gradient text-white rounded-xl text-xs font-black shadow-lg shadow-brand-200">ANALIZAR</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        function toggleCampos() {
            var select = document.getElementById("selectTipo");
            var idTipo = select.value;
            var option = select.options[select.selectedIndex];
            var nombreTipo = option.getAttribute("data-nombre") || "";

            var colModelo = document.getElementById("col-modelo");
            var selectModelo = document.getElementById("selector-modelo");
            var colReferencia = document.getElementById("col-referencia");
            var llevaModelo = ["TABLET", "PORTATIL", "COMPUTADOR", "PC", "MONITOR", "CELULAR"].some(t => nombreTipo.includes(t));

            if (llevaModelo) {
                colModelo.style.display = "block";
                var opciones = selectModelo.querySelectorAll('option');
                opciones.forEach(opt => {
                    if (opt.value === "") return;
                    if (opt.getAttribute('data-tipo') == idTipo) {
                        opt.style.display = "block";
                    } else {
                        opt.style.display = "none";
                    }
                });
            } else {
                colModelo.style.display = "none";
                selectModelo.value = "";
            }

            var esPC = ["TABLET", "COMPUTADOR", "PORTATIL", "PC", "SERVIDOR", "AIO"].some(t => nombreTipo.includes(t));
            document.getElementById("grupo-hostname").style.display = esPC ? "block" : "none";
            document.getElementById("grupo-redes").style.display = esPC ? "block" : "none";
            
            var selectPadre = document.getElementsByName("id_padre_activo")[0];
            if (esPC) {
                selectPadre.value = ""; 
                document.getElementById("grupo-padre").style.display = "none";
            } else {
                document.getElementById("grupo-padre").style.display = "block";
            }
        }

        function prepararYEnviar() {
            var accesorios = [];
            var tabla = document.getElementById("tablaAccesorios");
            if (tabla) {
                var filas = tabla.querySelectorAll("tbody tr");
                filas.forEach(tr => {
                    accesorios.push({
                        tipo: tr.querySelector(".acc-tipo").value,
                        marca: tr.querySelector(".acc-marca").value,
                        serial: tr.querySelector(".acc-serial").value,
                        referencia: tr.querySelector(".acc-ref").value
                    });
                });
                document.getElementById("accesoriosJson").value = JSON.stringify(accesorios);
            }
            document.getElementById("formCrear").submit();
        }

        // --- FUNCIÓN AGREGADA Y CORREGIDA PARA BÚSQUEDA ---
        async function buscarEmpleado() {
            // Referencias a los IDs (¡AHORA SÍ EXISTEN EN EL HTML!)
            const idInput = document.getElementById('input-responsable');
            const nomInput = document.getElementById('nom_nuevo_empleado');
            const areaSelect = document.getElementById('id_area_nuevo');
            const icon = document.getElementById('icon-search');
            const alerta = document.getElementById('alerta-empleado');
            
            const id = idInput.value.trim();
            if(!id) { 
                alerta.innerHTML = "<span class='text-brand-600'>⚠️ Por favor ingrese un número de cédula.</span>"; 
                return; 
            }
            
            // Icono de carga visual
            icon.className = 'fas fa-spinner fa-spin';
            
            try {
                // Llamamos al endpoint que ya existe en tu main.py
                const res = await fetch(`/api/empleado/${id}`);
                
                if(res.ok) {
                    const data = await res.json();
                    
                    // Caso 1: ENCONTRADO
                    nomInput.value = data.nombre;
                    nomInput.readOnly = true; 
                    nomInput.style.backgroundColor = "#e2e8f0"; // Gris claro para indicar que está bloqueado
                    nomInput.classList.add("text-slate-500");
                    
                    if (data.id_area) {
                        areaSelect.value = data.id_area;
                    }
                    
                    // Feedback visual verde
                    alerta.innerHTML = `<span class='text-green-600'><i class='fas fa-check-circle'></i> Empleado verificado: ${data.nombre}</span>`;
                    idInput.parentElement.style.borderColor = "#10b981"; // Borde verde
                } else {
                    // Caso 2: NO ENCONTRADO (404)
                    nomInput.value = "";
                    nomInput.readOnly = false;
                    nomInput.style.backgroundColor = "transparent";
                    nomInput.classList.remove("text-slate-500");
                    nomInput.placeholder = "No existe. Ingrese nombre para crearlo.";
                    nomInput.focus(); // Ponemos el foco para que escriba el nombre
                    areaSelect.value = "";
                    
                    // Feedback visual naranja
                    alerta.innerHTML = "<span class='text-orange-500'><i class='fas fa-info-circle'></i> Nuevo custodio. Por favor registre sus datos.</span>";
                    idInput.parentElement.style.borderColor = "#f97316"; // Borde naranja
                }
            } catch(e) { 
                console.error(e);
                alerta.innerHTML = "<span class='text-red-600'>Error de conexión con el servidor.</span>";
            } finally { 
                // Restaurar icono de lupa
                icon.className = 'fas fa-search'; 
            }
        }

        document.addEventListener('DOMContentLoaded', toggleCampos);
    </script>
</body>
</html>